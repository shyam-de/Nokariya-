// Indian States and Union Territories
export const INDIAN_STATES = [
  'Andhra Pradesh',
  'Arunachal Pradesh',
  'Assam',
  'Bihar',
  'Chhattisgarh',
  'Goa',
  'Gujarat',
  'Haryana',
  'Himachal Pradesh',
  'Jharkhand',
  'Karnataka',
  'Kerala',
  'Madhya Pradesh',
  'Maharashtra',
  'Manipur',
  'Meghalaya',
  'Mizoram',
  'Nagaland',
  'Odisha',
  'Punjab',
  'Rajasthan',
  'Sikkim',
  'Tamil Nadu',
  'Telangana',
  'Tripura',
  'Uttar Pradesh',
  'Uttarakhand',
  'West Bengal',
  'Andaman and Nicobar Islands',
  'Chandigarh',
  'Dadra and Nagar Haveli and Daman and Diu',
  'Delhi',
  'Jammu and Kashmir',
  'Ladakh',
  'Lakshadweep',
  'Puducherry'
]

// Major Indian Cities (comprehensive list)
export const INDIAN_CITIES = [
  // Andhra Pradesh
  'Visakhapatnam', 'Vijayawada', 'Guntur', 'Nellore', 'Kurnool', 'Rajahmundry', 'Kakinada', 'Tirupati', 'Kadapa', 'Anantapur',
  // Arunachal Pradesh
  'Itanagar', 'Naharlagun', 'Pasighat', 'Tawang', 'Bomdila',
  // Assam
  'Guwahati', 'Silchar', 'Dibrugarh', 'Jorhat', 'Nagaon', 'Tinsukia', 'Tezpur', 'Bongaigaon', 'Dhubri', 'Sivasagar',
  // Bihar
  'Patna', 'Gaya', 'Bhagalpur', 'Muzaffarpur', 'Purnia', 'Darbhanga', 'Arrah', 'Bihar Sharif', 'Katihar', 'Munger',
  // Chhattisgarh
  'Raipur', 'Bhilai', 'Bilaspur', 'Durg', 'Korba', 'Raigarh', 'Jagdalpur', 'Ambikapur', 'Rajnandgaon', 'Dhamtari',
  // Goa
  'Panaji', 'Margao', 'Vasco da Gama', 'Mapusa', 'Ponda',
  // Gujarat
  'Ahmedabad', 'Surat', 'Vadodara', 'Rajkot', 'Bhavnagar', 'Jamnagar', 'Gandhinagar', 'Junagadh', 'Anand', 'Navsari',
  // Haryana
  'Faridabad', 'Gurgaon', 'Panipat', 'Ambala', 'Yamunanagar', 'Rohtak', 'Hisar', 'Karnal', 'Sonipat', 'Panchkula',
  // Himachal Pradesh
  'Shimla', 'Mandi', 'Solan', 'Dharamshala', 'Bilaspur', 'Kullu', 'Chamba', 'Hamirpur', 'Una', 'Nahan',
  // Jharkhand
  'Ranchi', 'Jamshedpur', 'Dhanbad', 'Bokaro Steel City', 'Hazaribagh', 'Deoghar', 'Giridih', 'Ramgarh', 'Medininagar', 'Chaibasa',
  // Karnataka
  'Bangalore', 'Mysore', 'Mysuru', 'Hubli', 'Mangalore', 'Belgaum', 'Gulbarga', 'Davangere', 'Bellary', 'Bijapur', 'Shimoga',
  // Kerala
  'Kochi', 'Thiruvananthapuram', 'Kozhikode', 'Thrissur', 'Kollam', 'Alappuzha', 'Kannur', 'Kottayam', 'Palakkad', 'Malappuram',
  // Madhya Pradesh
  'Indore', 'Bhopal', 'Gwalior', 'Jabalpur', 'Raipur', 'Ujjain', 'Sagar', 'Dewas', 'Satna', 'Ratlam',
  // Maharashtra
  'Mumbai', 'Pune', 'Nagpur', 'Thane', 'Nashik', 'Aurangabad', 'Solapur', 'Amravati', 'Kolhapur', 'Sangli',
  // Manipur
  'Imphal', 'Thoubal', 'Bishnupur', 'Churachandpur', 'Ukhrul',
  // Meghalaya
  'Shillong', 'Tura', 'Jowai', 'Nongstoin', 'Williamnagar',
  // Mizoram
  'Aizawl', 'Lunglei', 'Saiha', 'Champhai', 'Kolasib',
  // Nagaland
  'Kohima', 'Dimapur', 'Mokokchung', 'Tuensang', 'Wokha',
  // Odisha
  'Bhubaneswar', 'Cuttack', 'Rourkela', 'Berhampur', 'Sambalpur', 'Puri', 'Balasore', 'Bhadrak', 'Baripada', 'Jharsuguda',
  // Punjab
  'Ludhiana', 'Amritsar', 'Jalandhar', 'Patiala', 'Bathinda', 'Pathankot', 'Hoshiarpur', 'Batala', 'Moga', 'Abohar',
  // Rajasthan
  'Jaipur', 'Jodhpur', 'Kota', 'Bikaner', 'Ajmer', 'Udaipur', 'Bhilwara', 'Alwar', 'Bharatpur', 'Sikar',
  // Sikkim
  'Gangtok', 'Namchi', 'Mangan', 'Gyalshing',
  // Tamil Nadu
  'Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem', 'Tirunelveli', 'Erode', 'Vellore', 'Dindigul', 'Thanjavur',
  // Telangana
  'Hyderabad', 'Warangal', 'Nizamabad', 'Karimnagar', 'Ramagundam', 'Khammam', 'Mahbubnagar', 'Nalgonda', 'Adilabad', 'Siddipet',
  // Tripura
  'Agartala', 'Udaipur', 'Dharmanagar', 'Kailasahar', 'Belonia',
  // Uttar Pradesh
  'Lucknow', 'Kanpur', 'Agra', 'Varanasi', 'Allahabad', 'Meerut', 'Ghaziabad', 'Bareilly', 'Aligarh', 'Moradabad',
  // Uttarakhand
  'Dehradun', 'Haridwar', 'Roorkee', 'Haldwani', 'Rudrapur', 'Kashipur', 'Rishikesh', 'Nainital', 'Almora', 'Pithoragarh',
  // West Bengal
  'Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri', 'Bardhaman', 'Malda', 'Kharagpur', 'Baharampur', 'Jalpaiguri',
  // Union Territories
  'Port Blair', // Andaman and Nicobar
  'Chandigarh',
  'Daman', 'Diu', 'Silvassa', // Dadra and Nagar Haveli and Daman and Diu
  'New Delhi', 'Delhi',
  'Srinagar', 'Jammu', // Jammu and Kashmir
  'Leh', 'Kargil', // Ladakh
  'Kavaratti', // Lakshadweep
  'Puducherry', 'Karaikal', 'Mahe', 'Yanam'
]

// Normalize string for comparison (remove extra spaces, convert to lowercase)
const normalizeString = (str: string): string => {
  return str.trim().toLowerCase().replace(/\s+/g, ' ')
}

// Check if state is valid
export const isValidIndianState = (state: string): boolean => {
  if (!state || state.trim().length === 0) return false
  const normalized = normalizeString(state)
  return INDIAN_STATES.some(validState => normalizeString(validState) === normalized)
}

// Check if city is valid
export const isValidIndianCity = (city: string): boolean => {
  if (!city || city.trim().length === 0) return false
  const normalized = normalizeString(city)
  return INDIAN_CITIES.some(validCity => normalizeString(validCity) === normalized)
}

// Get suggestions for state (fuzzy match)
export const getStateSuggestions = (input: string, limit: number = 5): string[] => {
  if (!input || input.trim().length < 2) return []
  const normalized = normalizeString(input)
  return INDIAN_STATES
    .filter(state => normalizeString(state).includes(normalized))
    .slice(0, limit)
}

// Get suggestions for city (fuzzy match)
export const getCitySuggestions = (input: string, limit: number = 5): string[] => {
  if (!input || input.trim().length < 2) return []
  const normalized = normalizeString(input)
  return INDIAN_CITIES
    .filter(city => normalizeString(city).includes(normalized))
    .slice(0, limit)
}

// Calculate distance between two coordinates using Haversine formula
const calculateDistance = (lat1: number, lon1: number, lat2: number, lon2: number): number => {
  const R = 6371 // Radius of the Earth in km
  const dLat = (lat2 - lat1) * Math.PI / 180
  const dLon = (lon2 - lon1) * Math.PI / 180
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2)
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
  return R * c
}

// Get nearest cities based on GPS coordinates
export const getNearestCities = async (
  latitude: number, 
  longitude: number, 
  limit: number = 5
): Promise<Array<{ city: string; distance: number; state?: string }>> => {
  try {
    // First, get the state from reverse geocoding
    const reverseResponse = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`,
      {
        headers: {
          'User-Agent': 'KaamKart-App'
        }
      }
    )
    const reverseData = await reverseResponse.json()
    const detectedState = reverseData?.address?.state || reverseData?.address?.region || ''
    
    // Search for nearby cities using Nominatim
    // Search in a 50km radius for cities
    const searchResponse = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=city&lat=${latitude}&lon=${longitude}&radius=50000&limit=50&countrycodes=in`,
      {
        headers: {
          'User-Agent': 'KaamKart-App'
        }
      }
    )
    const searchData = await searchResponse.json()
    
    // Match found places with our city list and calculate distances
    const matchedCities: Array<{ city: string; distance: number }> = []
    const processedCities = new Set<string>()
    
    for (const place of searchData || []) {
      const placeCity = place.address?.city || place.address?.town || place.address?.village || place.address?.county || ''
      const placeLat = parseFloat(place.lat)
      const placeLon = parseFloat(place.lon)
      
      if (!placeCity || !placeLat || !placeLon) continue
      
      // Check if this place matches any city in our list
      for (const validCity of INDIAN_CITIES) {
        const normalizedPlaceCity = normalizeString(placeCity)
        const normalizedValidCity = normalizeString(validCity)
        
        // Check for exact match or if one contains the other
        if (normalizedPlaceCity === normalizedValidCity || 
            normalizedPlaceCity.includes(normalizedValidCity) ||
            normalizedValidCity.includes(normalizedPlaceCity)) {
          
          if (!processedCities.has(validCity)) {
            const distance = calculateDistance(latitude, longitude, placeLat, placeLon)
            matchedCities.push({ city: validCity, distance })
            processedCities.add(validCity)
          }
          break
        }
      }
    }
    
    // Sort by distance
    matchedCities.sort((a, b) => a.distance - b.distance)
    
    // Filter cities within 50km radius
    const citiesWithin50km = matchedCities.filter(city => city.distance <= 50)
    
    // If we don't have enough results within 50km, geocode some popular cities from the detected state
    if (citiesWithin50km.length < limit) {
      // Get a subset of cities to geocode (prioritize major cities)
      const citiesToGeocode = INDIAN_CITIES
        .filter(city => !processedCities.has(city))
        .slice(0, Math.min(20, limit * 3)) // Limit API calls
      
      // Geocode cities in batches (with delay to respect rate limits)
      for (let i = 0; i < citiesToGeocode.length && citiesWithin50km.length < limit; i++) {
        const city = citiesToGeocode[i]
        try {
          // Small delay to respect API rate limits
          if (i > 0) await new Promise(resolve => setTimeout(resolve, 200))
          
          const geoResponse = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + ', India')}&limit=1`,
            {
              headers: {
                'User-Agent': 'KaamKart-App'
              }
            }
          )
          const geoData = await geoResponse.json()
          
          if (geoData && geoData[0]) {
            const cityLat = parseFloat(geoData[0].lat)
            const cityLon = parseFloat(geoData[0].lon)
            if (cityLat && cityLon) {
              const distance = calculateDistance(latitude, longitude, cityLat, cityLon)
              // Only add if within 50km
              if (distance <= 50) {
                citiesWithin50km.push({ city, distance })
                processedCities.add(city)
              }
            }
          }
        } catch (err) {
          console.error(`Error geocoding ${city}:`, err)
        }
      }
      
      // Sort again after adding geocoded cities
      citiesWithin50km.sort((a, b) => a.distance - b.distance)
    }
    
    // Return only cities within 50km
    return citiesWithin50km.slice(0, limit).map(c => ({ 
      city: c.city, 
      distance: Math.round(c.distance * 10) / 10 // Round to 1 decimal place
    }))
  } catch (error) {
    console.error('Error finding nearest cities:', error)
    // Fallback: return popular cities
    return INDIAN_CITIES.slice(0, limit).map(city => ({ city, distance: 0 }))
  }
}

// Get state and city from pin code (for registration form)
export const getLocationFromPinCode = async (pinCode: string): Promise<{ state: string; city: string } | null> => {
  if (!pinCode || pinCode.length !== 6) return null
  
  try {
    // Using India Post Pin Code API (free, no API key required)
    const response = await fetch(`https://api.postalpincode.in/pincode/${pinCode}`)
    const data = await response.json()
    
    if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice && data[0].PostOffice.length > 0) {
      const postOffice = data[0].PostOffice[0]
      const state = postOffice.State || ''
      const city = postOffice.District || postOffice.Name || ''
      
      if (state && city) {
        return { state, city }
      }
    }
    return null
  } catch (error) {
    console.error('Error fetching location from pin code:', error)
    return null
  }
}

